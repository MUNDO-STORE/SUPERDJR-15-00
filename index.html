<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Store Chat - Real Time</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #00cec9; --dark-glass: rgba(0, 0, 0, 0.8); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #6c5ce7);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Modal */
        #welcomeModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 15px; text-align: center; border: 2px solid var(--primary); width: 90%; max-width: 400px; }
        
        /* Grid de VÃ­deo */
        .main-wrapper { display: grid; grid-template-columns: 1fr 350px; height: 100vh; padding: 15px; gap: 15px; }
        
        .video-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--dark-glass);
            padding: 10px; border-radius: 15px; position: relative;
        }

        video { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; background: #000; }
        .label { position: absolute; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 12px; margin: 5px; }

        /* Chat */
        .chat-container { background: var(--dark-glass); border-radius: 15px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        #chatMessages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; }
        .msg b { color: var(--accent); }
        .chat-input-area { padding: 15px; display: flex; gap: 5px; }
        input { flex: 1; padding: 10px; border-radius: 5px; border: none; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="welcomeModal">
    <div class="modal-content">
        <h2>Mundo Store Chat</h2>
        <p>Seu ID: <span id="my-id" style="color:var(--accent)">Gerando...</span></p><br>
        <input type="text" id="peer-id-input" placeholder="ID do amigo para ligar">
        <button class="btn btn-primary" onclick="conectarAmigo()">CONECTAR AMIGO</button>
        <hr style="margin:20px 0; opacity:0.2">
        <button class="btn btn-primary" style="background:#2ecc71" onclick="fecharModal()">APENAS ENTRAR</button>
    </div>
</div>

<div class="main-wrapper">
    <div class="video-grid">
        <div style="position:relative">
            <span class="label">VocÃª</span>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
        <div style="position:relative">
            <span class="label">Amigo</span>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="toggleMute()">ðŸŽ¤ Mic</button>
            <button class="btn btn-primary" onclick="toggleVid()">ðŸ“· Cam</button>
        </div>
    </div>

    <div class="chat-container">
        <div style="padding:15px; background: var(--primary)">Bate-papo Global</div>
        <div id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Mensagem...">
            <button class="btn btn-primary" onclick="enviarMensagem()">Enviar</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer(); // Cria um ID Ãºnico para cada usuÃ¡rio
    let myStream;
    let currentConn;

    // 1. Ao abrir, mostrar o ID do usuÃ¡rio
    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
    });

    // 2. Acessar CÃ¢mera
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        myStream = stream;
        document.getElementById('localVideo').srcObject = stream;
    });

    // 3. Receber LigaÃ§Ã£o/VÃ­deo
    peer.on('call', (call) => {
        call.answer(myStream);
        call.on('stream', (remoteStream) => {
            document.getElementById('remoteVideo').srcObject = remoteStream;
        });
    });

    // 4. Receber Mensagens de Chat
    peer.on('connection', (conn) => {
        currentConn = conn;
        configurarConexao();
    });

    function conectarAmigo() {
        const remoteId = document.getElementById('peer-id-input').value;
        
        // Iniciar VÃ­deo
        const call = peer.call(remoteId, myStream);
        call.on('stream', (remoteStream) => {
            document.getElementById('remoteVideo').srcObject = remoteStream;
        });

        // Iniciar Chat
        currentConn = peer.connect(remoteId);
        configurarConexao();
        fecharModal();
    }

    function configurarConexao() {
        currentConn.on('data', (data) => {
            exibirMensagem("Amigo", data);
        });
    }

    function enviarMensagem() {
        const msg = document.getElementById('chatInput').value;
        if (currentConn && msg) {
            currentConn.send(msg);
            exibirMensagem("VocÃª", msg);
            document.getElementById('chatInput').value = "";
        } else {
            alert("Conecte-se a alguÃ©m primeiro pelo ID!");
        }
    }

    function exibirMensagem(autor, texto) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${autor}:</b> ${texto}`;
        document.getElementById('chatMessages').appendChild(div);
    }

    function fecharModal() { document.getElementById('welcomeModal').style.display = 'none'; }
    
    function toggleMute() { myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled; }
    function toggleVid() { myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled; }
</script>

</body>
</html>
