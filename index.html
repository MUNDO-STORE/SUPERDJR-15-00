<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Store Chat | ConexÃ£o AutomÃ¡tica</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #00cec9; --bg: #0f0c29; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #6c5ce7);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
            color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Modal Inicial */
        #setupModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(15px);
        }
        .modal-box { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 2px solid var(--primary); text-align: center; width: 90%; max-width: 400px; }
        
        /* Layout Principal */
        .app-container { display: grid; grid-template-columns: 1fr 350px; height: 100vh; padding: 20px; gap: 20px; }
        
        .video-section { position: relative; background: rgba(0,0,0,0.4); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Grid de VÃ­deos (Suporta mÃºltiplos) */
        #videoGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; padding: 10px; flex-grow: 1; }
        video { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; background: #222; border: 2px solid rgba(255,255,255,0.1); }

        /* Chat Lateral */
        .chat-sidebar { background: rgba(0,0,0,0.6); border-radius: 20px; display: flex; flex-direction: column; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        #chatBox { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .input-area { padding: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; outline: none; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:hover { background: var(--accent); color: #000; }

        .controls-bar { padding: 15px; display: flex; justify-content: center; gap: 20px; background: rgba(0,0,0,0.3); }

        @media (max-width: 800px) { .app-container { grid-template-columns: 1fr; } .chat-sidebar { height: 300px; } }
    </style>
</head>
<body>

<div id="setupModal">
    <div class="modal-box">
        <h2 style="color: var(--accent); margin-bottom: 10px;">MUNDO STORE CHAT</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">VocÃª entrarÃ¡ na sala principal automaticamente.</p>
        <input type="text" id="userNameInput" placeholder="Digite seu apelido..." style="width: 100%; margin-bottom: 15px;">
        <button class="btn btn-main" style="width: 100%;" onclick="startApp()">ENTRAR NO CHAT</button>
    </div>
</div>

<div class="app-container">
    <div class="video-section">
        <div id="videoGrid">
            <div style="position:relative">
                <video id="localVideo" autoplay playsinline muted></video>
                <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); padding:2px 10px; border-radius:5px; font-size:12px">VocÃª</div>
            </div>
        </div>
        
        <div class="controls-bar">
            <button class="btn btn-main" onclick="toggleMic()">ðŸŽ¤ Mic</button>
            <button class="btn btn-main" onclick="toggleCam()">ðŸ“· Cam</button>
            <button class="btn" style="background: #ff7675; color: white;" onclick="location.reload()">Sair</button>
        </div>
    </div>

    <div class="chat-sidebar">
        <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold;">ðŸ’¬ Chat Ao Vivo</div>
        <div id="chatBox"></div>
        <div class="input-area">
            <input type="text" id="chatInput" placeholder="Escreva algo...">
            <button class="btn btn-main" onclick="sendMessage()">Enviar</button>
        </div>
    </div>
</div>

<script>
    let myStream;
    let peer;
    let userName = "";
    const ROOM_ID = "mundo-store-sala-001"; // Sala Ãºnica para todos
    const peers = {};

    async function startApp() {
        userName = document.getElementById('userNameInput').value || "AnÃ´nimo";
        document.getElementById('setupModal').style.display = 'none';

        // 1. Pegar CÃ¢mera
        myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = myStream;

        // 2. Inicializar PeerJS
        // Em um sistema real, aqui vocÃª usaria um servidor de sinalizaÃ§Ã£o para listar quem estÃ¡ online.
        // Como estamos no navegador, vamos gerar um ID e vocÃª pode convidar pessoas.
        peer = new Peer();

        peer.on('open', id => {
            console.log("Meu ID:", id);
            addChatMessage("Sistema", `VocÃª entrou como <b>${userName}</b>`);
        });

        // Ouvir chamadas de vÃ­deo
        peer.on('call', call => {
            call.answer(myStream);
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream);
            });
        });

        // Ouvir mensagens de texto
        peer.on('connection', conn => {
            conn.on('data', data => {
                addChatMessage(data.user, data.msg);
            });
        });
    }

    function addVideoStream(video, stream) {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => video.play());
        document.getElementById('videoGrid').append(video);
    }

    function addChatMessage(user, msg) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${user}:</b> ${msg}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        if (input.value.trim() === "") return;

        addChatMessage("VocÃª", input.value);
        
        // No PeerJS simples sem servidor de broadcast, o envio Ã© peer-to-peer.
        // Para broadcast real automÃ¡tico, seria necessÃ¡rio Node.js + Socket.io.
        input.value = "";
    }

    function toggleMic() { myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled; }
    function toggleCam() { myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled; }

    document.getElementById('chatInput').addEventListener('keypress', e => {
        if(e.key === 'Enter') sendMessage();
    });
</script>

</body>
</html>
