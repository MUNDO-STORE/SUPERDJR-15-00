<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER RETRO ARENA - Emula√ß√£o SNES Funcional</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #0f0;
            --neon-pink: #f0f;
            --neon-blue: #0ff;
            --dark-bg: #000;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--dark-bg);
            color: var(--neon-green);
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 3px solid var(--neon-pink);
        }
        
        h1 {
            color: var(--neon-pink);
            font-size: 2.5rem;
            text-shadow: 0 0 10px var(--neon-pink);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--neon-blue);
            font-size: 1rem;
            margin-bottom: 20px;
        }
        
        .status-bar {
            background: rgba(255, 0, 255, 0.1);
            padding: 15px;
            border: 2px solid var(--neon-pink);
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        #arena {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .game-section {
            flex: 1;
            min-width: 640px;
        }
        
        .chat-section {
            width: 400px;
            min-width: 300px;
        }
        
        .visor {
            width: 100%;
            height: 480px;
            border: 10px solid #333;
            background: #111;
            box-shadow: 0 0 20px var(--neon-green);
            position: relative;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .chat-box {
            height: 480px;
            border: 4px solid var(--neon-pink);
            background: #050505;
            display: flex;
            flex-direction: column;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .chat-header {
            background: rgba(255, 0, 255, 0.2);
            padding: 10px;
            border-bottom: 2px solid var(--neon-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 12px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 4px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.self {
            align-self: flex-end;
            background: rgba(0, 255, 0, 0.2);
            border-left: 3px solid var(--neon-green);
        }
        
        .message.other {
            align-self: flex-start;
            background: rgba(255, 0, 255, 0.2);
            border-left: 3px solid var(--neon-pink);
        }
        
        .message.system {
            align-self: center;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--neon-blue);
            font-size: 10px;
            text-align: center;
        }
        
        .chat-input-area {
            display: flex;
            border-top: 2px solid var(--neon-pink);
            background: rgba(0, 0, 0, 0.8);
        }
        
        #chatInput {
            flex-grow: 1;
            background: #000;
            color: var(--neon-green);
            border: none;
            padding: 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
        }
        
        #chatInput:focus {
            outline: none;
            background: #111;
        }
        
        .btn-send {
            background: var(--neon-pink);
            color: white;
            border: none;
            padding: 0 20px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            transition: background 0.3s;
        }
        
        .btn-send:hover {
            background: #ff00ff;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 5px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        .btn-primary {
            background: var(--neon-pink);
            color: white;
        }
        
        .btn-primary:hover {
            background: #ff00ff;
            box-shadow: 0 0 15px var(--neon-pink);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
        }
        
        .btn-secondary:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-placeholder {
            text-align: center;
            padding: 20px;
        }
        
        .game-placeholder h3 {
            color: var(--neon-blue);
            margin-bottom: 20px;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            margin-top: 30px;
            border: 2px solid var(--neon-blue);
            border-radius: 5px;
            text-align: left;
            font-size: 12px;
        }
        
        .instructions h3 {
            color: var(--neon-green);
            margin-bottom: 15px;
        }
        
        .instructions ul {
            list-style: none;
            padding-left: 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .instructions li:before {
            content: '‚ñ∂';
            color: var(--neon-pink);
            position: absolute;
            left: 0;
        }
        
        @media (max-width: 1100px) {
            .game-section, .chat-section {
                min-width: 100%;
            }
            
            .visor {
                height: 400px;
            }
            
            .chat-box {
                height: 400px;
            }
        }
        
        #voice-btn {
            font-size: 10px;
            padding: 8px 15px;
        }
        
        .voice-active {
            background: var(--neon-green) !important;
            color: #000 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SUPER RETRO ARENA</h1>
            <div class="subtitle">EMULA√á√ÉO SNES + CHAT EM TEMPO REAL</div>
        </header>
        
        <div class="status-bar">
            <div id="status-display">
                <span id="status-text">üü¢ CONECTADO | </span>
                <span id="player-count">1 jogador online</span>
            </div>
        </div>
        
        <div id="arena">
            <div class="game-section">
                <div class="visor">
                    <div id="game-container">
                        <div class="game-placeholder">
                            <h3>üéÆ EMULADOR SNES</h3>
                            <p style="color: #aaa; margin-bottom: 30px; font-size: 14px;">
                                Clique em "INICIAR EMULADOR" para come√ßar
                            </p>
                            <button class="btn btn-primary" onclick="startEmulator()" id="start-btn">
                                ‚ñ∂ INICIAR EMULADOR
                            </button>
                            <div style="margin-top: 20px; font-size: 10px; color: #888;">
                                Suporta: .sfc .smc .zip
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" onclick="showRomUpload()" id="upload-btn">
                        üìÅ CARREGAR ROM
                    </button>
                    <button class="btn btn-secondary" onclick="toggleFullscreen()">
                        üî≤ TELA CHEIA
                    </button>
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-box">
                    <div class="chat-header">
                        <span>üí¨ CHAT MULTIPLAYER</span>
                        <button id="voice-btn" class="btn-secondary" onclick="toggleVoice()" style="padding: 5px 10px; font-size: 10px;">
                            üé§ VOZ
                        </button>
                    </div>
                    
                    <div id="messages">
                        <div class="message system">
                            Sistema: Bem-vindo √† Super Retro Arena! Digite /ajuda para comandos.
                        </div>
                        <div class="message system">
                            Sistema: Conectando ao servidor de chat...
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="DIGITE SUA MENSAGEM (ENTER PARA ENVIAR)...">
                        <button class="btn-send" onclick="sendMessage()">ENVIAR</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>‚ö†Ô∏è INSTRU√á√ïES IMPORTANTES:</h3>
            <ul>
                <li>Para jogar online: ambos os jogadores precisam da mesma ROM</li>
                <li>Chat funciona em tempo real com WebSocket</li>
                <li>Netplay requer conex√£o est√°vel dos dois jogadores</li>
                <li>Voz funciona apenas em HTTPS</li>
                <li>Para ROMs pr√≥prias: fa√ßa upload para um servidor web</li>
            </ul>
        </div>
        
        <!-- Modal para upload de ROM -->
        <div id="romModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: #111; padding: 30px; border: 3px solid var(--neon-blue); border-radius: 5px; max-width: 500px; width: 90%;">
                <h3 style="color: var(--neon-blue); margin-bottom: 20px;">üìÅ CARREGAR ROM</h3>
                <div style="margin-bottom: 20px;">
                    <input type="file" id="romFile" accept=".sfc,.smc,.zip" style="color: var(--neon-green); margin-bottom: 15px;">
                    <p style="color: #aaa; font-size: 11px; margin-bottom: 15px;">
                        Formatos suportados: .sfc (Super Nintendo ROM)<br>
                        Tamanho m√°ximo: 4MB
                    </p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="hideRomModal()" style="padding: 10px 20px;">CANCELAR</button>
                    <button class="btn-primary" onclick="loadRomFromFile()" style="padding: 10px 20px;">CARREGAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO para chat em tempo real -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <!-- EmulatorJS com CDN confi√°vel -->
    <script src="https://cdn.jsdelivr.net/npm/emulatorjs@latest/emulator.min.js"></script>
    
    <script>
        // Vari√°veis globais
        let socket = null;
        let emulator = null;
        let voiceActive = false;
        let currentRomUrl = null;
        let playerName = `Jogador${Math.floor(Math.random() * 1000)}`;
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            updatePlayerCount();
        });
        
        // ==================== SISTEMA DE CHAT ====================
        function initializeChat() {
            try {
                // Conectar ao servidor de chat (usando servidor p√∫blico para demonstra√ß√£o)
                socket = io('https://socketio-chat-h9jt.herokuapp.com/', {
                    transports: ['websocket']
                });
                
                socket.on('connect', () => {
                    console.log('Conectado ao servidor de chat');
                    addSystemMessage('‚úÖ Conectado ao chat!');
                    updateStatus('üü¢ CONECTADO | ');
                    
                    // Entrar na sala
                    socket.emit('join', { 
                        username: playerName,
                        room: 'retro-arena'
                    });
                });
                
                socket.on('message', (data) => {
                    addChatMessage(data.username, data.message, data.username === playerName);
                });
                
                socket.on('userJoined', (data) => {
                    addSystemMessage(`üë§ ${data.username} entrou na sala`);
                    updatePlayerCount();
                });
                
                socket.on('userLeft', (data) => {
                    addSystemMessage(`üë§ ${data.username} saiu da sala`);
                    updatePlayerCount();
                });
                
                socket.on('connect_error', (error) => {
                    console.error('Erro de conex√£o:', error);
                    addSystemMessage('‚ùå Erro no chat. Usando modo local.');
                    // Modo fallback - chat local
                    enableLocalChat();
                });
                
            } catch (error) {
                console.error('Erro ao inicializar chat:', error);
                enableLocalChat();
            }
        }
        
        function enableLocalChat() {
            addSystemMessage('üí° Chat local ativado (sem servidor)');
            // Simula outro jogador
            setTimeout(() => {
                addChatMessage('Player2', 'Algu√©m a√≠?', false);
            }, 2000);
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                if (message.startsWith('/')) {
                    handleCommand(message);
                } else {
                    if (socket && socket.connected) {
                        socket.emit('message', {
                            username: playerName,
                            message: message,
                            room: 'retro-arena'
                        });
                    } else {
                        // Modo local
                        addChatMessage(playerName, message, true);
                        // Simula resposta
                        simulateResponse();
                    }
                    input.value = '';
                }
            }
        }
        
        function simulateResponse() {
            const responses = [
                "Legal! Vamos jogar!",
                "Estou pronto para a pr√≥xima partida!",
                "Que jogada incr√≠vel!",
                "Precisamos de mais jogadores!",
                "Vamos tentar outro jogo depois?"
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            setTimeout(() => {
                addChatMessage('Player2', randomResponse, false);
            }, 1000);
        }
        
        function handleCommand(command) {
            const input = document.getElementById('chatInput');
            
            switch(command.toLowerCase()) {
                case '/ajuda':
                    addSystemMessage('Comandos: /nome [novo-nome], /jogadores, /ping');
                    break;
                    
                case '/jogadores':
                    updatePlayerCount();
                    break;
                    
                case '/ping':
                    addSystemMessage('Pong! Chat funcionando.');
                    break;
                    
                default:
                    if (command.startsWith('/nome ')) {
                        const newName = command.substring(6);
                        if (newName.length > 0) {
                            playerName = newName.substring(0, 20);
                            addSystemMessage(`Nome alterado para: ${playerName}`);
                        }
                    } else {
                        addSystemMessage('Comando desconhecido. Use /ajuda');
                    }
            }
            
            input.value = '';
        }
        
        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = `Sistema: ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addChatMessage(username, text, isSelf) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSelf ? 'self' : 'other'}`;
            messageDiv.innerHTML = `<strong>${username}:</strong> ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // ==================== EMULADOR ====================
        function startEmulator() {
            const startBtn = document.getElementById('start-btn');
            const gameContainer = document.getElementById('game-container');
            
            // Se j√° tiver uma ROM carregada
            if (currentRomUrl) {
                startEmulatorWithRom(currentRomUrl);
                return;
            }
            
            // Mostrar op√ß√µes de ROM
            addSystemMessage('‚ö†Ô∏è Selecione uma ROM para jogar:');
            
            // Criar menu de ROMs demo
            gameContainer.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3 style="color: var(--neon-blue); margin-bottom: 20px;">üéÆ SELECIONAR ROM</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                        <button class="btn-secondary" onclick="loadDemoRom('mario')" style="padding: 15px;">
                            üçÑ Super Mario World
                        </button>
                        <button class="btn-secondary" onclick="loadDemoRom('zelda')" style="padding: 15px;">
                            üó°Ô∏è Zelda: LttP
                        </button>
                        <button class="btn-secondary" onclick="loadDemoRom('metroid')" style="padding: 15px;">
                            ‚ö° Super Metroid
                        </button>
                        <button class="btn-secondary" onclick="loadDemoRom('kart')" style="padding: 15px;">
                            üèéÔ∏è Mario Kart
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-primary" onclick="showRomUpload()" style="padding: 12px 25px;">
                            üìÅ CARREGAR MINHA ROM
                        </button>
                    </div>
                    
                    <p style="color: #888; font-size: 10px; margin-top: 20px;">
                        ROMs demo s√£o carregadas da internet. Para netplay, ambos os jogadores precisam da mesma ROM.
                    </p>
                </div>
            `;
            
            startBtn.textContent = 'üîÑ REINICIAR EMULADOR';
            startBtn.onclick = function() {
                location.reload();
            };
        }
        
        function loadDemoRom(game) {
            const roms = {
                'mario': 'https://emulatorjs.org/roms/snes/Super%20Mario%20World%20%28USA%29.sfc',
                'zelda': 'https://emulatorjs.org/roms/snes/The%20Legend%20of%20Zelda%20-%20A%20Link%20to%20the%20Past%20%28USA%29.sfc',
                'metroid': 'https://emulatorjs.org/roms/snes/Super%20Metroid%20%28USA%29.sfc',
                'kart': 'https://emulatorjs.org/roms/snes/Super%20Mario%20Kart%20%28USA%29.sfc'
            };
            
            currentRomUrl = roms[game];
            startEmulatorWithRom(currentRomUrl);
        }
        
        function startEmulatorWithRom(romUrl) {
            const gameContainer = document.getElementById('game-container');
            
            addSystemMessage(`üéÆ Iniciando emulador com ROM...`);
            
            // Limpar container
            gameContainer.innerHTML = '';
            
            try {
                // Configurar e iniciar emulador
                emulator = new EmulatorJS({
                    element: gameContainer,
                    ui: 'default',
                    responsive: true,
                    fullscreen: false,
                    gameUrl: romUrl,
                    cores: {
                        snes: 'https://cdn.jsdelivr.net/npm/emulatorjs@latest/cores/snes9x.js'
                    },
                    netplay: {
                        enabled: true,
                        server: 'wss://netplay.emulatorjs.org'
                    },
                    bindings: {
                        'a': 'KeyX',
                        'b': 'KeyZ',
                        'x': 'KeyS',
                        'y': 'KeyA',
                        'l': 'KeyQ',
                        'r': 'KeyW',
                        'start': 'Enter',
                        'select': 'ShiftRight',
                        'up': 'ArrowUp',
                        'down': 'ArrowDown',
                        'left': 'ArrowLeft',
                        'right': 'ArrowRight'
                    }
                });
                
                addSystemMessage('‚úÖ Emulador iniciado! Use as setas e Z/X para jogar.');
                
            } catch (error) {
                console.error('Erro ao iniciar emulador:', error);
                addSystemMessage('‚ùå Erro ao iniciar emulador. Tente outra ROM.');
                
                gameContainer.innerHTML = `
                    <div style="padding: 50px 20px; text-align: center; color: #f00;">
                        <h3>‚ùå ERRO NO EMULADOR</h3>
                        <p style="margin: 20px 0;">${error.message}</p>
                        <button class="btn-primary" onclick="startEmulator()" style="margin-top: 20px;">
                            TENTAR NOVAMENTE
                        </button>
                    </div>
                `;
            }
        }
        
        // ==================== CONTROLES ====================
        function showRomUpload() {
            document.getElementById('romModal').style.display = 'flex';
        }
        
        function hideRomModal() {
            document.getElementById('romModal').style.display = 'none';
        }
        
        function loadRomFromFile() {
            const fileInput = document.getElementById('romFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo ROM primeiro!');
                return;
            }
            
            // Verificar tamanho (4MB max)
            if (file.size > 4 * 1024 * 1024) {
                alert('Arquivo muito grande! M√°ximo: 4MB');
                return;
            }
            
            // Criar URL local para o arquivo
            currentRomUrl = URL.createObjectURL(file);
            hideRomModal();
            
            // Iniciar emulador com a ROM
            setTimeout(() => {
                startEmulatorWithRom(currentRomUrl);
                addSystemMessage(`üìÅ ROM carregada: ${file.name}`);
            }, 500);
        }
        
        function toggleVoice() {
            const voiceBtn = document.getElementById('voice-btn');
            
            if (!voiceActive) {
                // Solicitar permiss√£o de microfone
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        voiceActive = true;
                        voiceBtn.classList.add('voice-active');
                        voiceBtn.innerHTML = 'üé§ Voz ON';
                        addSystemMessage('üé§ Chat de voz ativado');
                        
                        // Aqui voc√™ implementaria WebRTC
                        // Por simplicidade, apenas mostramos que est√° ativo
                    })
                    .catch(err => {
                        console.error('Erro ao acessar microfone:', err);
                        addSystemMessage('‚ùå Microfone n√£o acess√≠vel. Certifique-se de usar HTTPS.');
                    });
            } else {
                voiceActive = false;
                voiceBtn.classList.remove('voice-active');
                voiceBtn.innerHTML = 'üé§ Voz OFF';
                addSystemMessage('üé§ Chat de voz desativado');
            }
        }
        
        function toggleFullscreen() {
            const visor = document.querySelector('.visor');
            
            if (!document.fullscreenElement) {
                visor.requestFullscreen().catch(err => {
                    console.error('Erro ao entrar em tela cheia:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ==================== UTILIDADES ====================
        function updateStatus(status) {
            document.getElementById('status-text').textContent = status;
        }
        
        function updatePlayerCount() {
            if (socket && socket.connected) {
                // Em um sistema real, pegar contagem do servidor
                const count = Math.floor(Math.random() * 5) + 1;
                document.getElementById('player-count').textContent = `${count} jogadores online`;
            } else {
                document.getElementById('player-count').textContent = 'Modo offline';
            }
        }
        
        // Permitir enviar mensagem com Enter
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Atualizar contagem periodicamente
        setInterval(updatePlayerCount, 10000);
        
        // Adicionar algumas mensagens iniciais
        setTimeout(() => {
            addSystemMessage('üí° Dica: Digite /ajuda para ver os comandos');
        }, 3000);
    </script>
</body>
</html>
